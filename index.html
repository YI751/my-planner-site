<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€AIæ©Ÿèƒ½æ­è¼‰ã€‘ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–Webåºƒå‘Šäºˆç®—ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #F8F9FA; }
        .tab-active { border-bottom-color: #0d9488; color: #0d9488; font-weight: 600; }
        .tab-inactive { border-bottom-color: transparent; color: #6b7280; }
        .nav-active { background-color: #14b8a6; color: white; }
        .nav-inactive { background-color: white; color: #374151; }
        .sim-mode-btn-active { background-color: #0d9488; color: white; }
        .sim-mode-btn-inactive { background-color: #f3f4f6; color: #374151; }
        .optional-input-btn-active { background-color: #14b8a6; color: white; }
        .optional-input-btn-inactive { background-color: #e5e7eb; color: #4b5563; }
        .case-study-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .case-study-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d9488;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .knowledge-card .formula {
            @apply bg-teal-50 border border-teal-200 text-teal-800 p-3 rounded-lg text-center text-base font-bold font-mono shadow-sm whitespace-nowrap overflow-x-auto;
        }
        .input-group, .optional-group {
            transition: opacity 0.3s ease-in-out;
        }
        .info-icon {
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.2s;
        }
        .info-icon:hover {
            color: #1f2937;
        }
        #tooltip {
            position: absolute;
            background-color: #1f2937;
            color: white;
            padding: 12px;
            border-radius: 8px;
            width: 280px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        #tooltip.visible {
            opacity: 1;
            visibility: visible;
        }
        #tooltip h4 {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 8px;
        }
        #tooltip p {
            font-size: 0.875rem;
            line-height: 1.5;
        }
        #tooltip .formula {
            background-color: #374151;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
            margin-top: 8px;
            word-break: break-all;
        }
        /* Custom input styles to match the desired image */
        .custom-input {
            border: none;
            border-bottom: 1px solid #d1d5db;
            border-radius: 0;
            padding-left: 0;
            padding-right: 2.5rem; /* Space for the unit */
            background-color: transparent;
        }
        .custom-input:focus {
            --tw-ring-shadow: none !important;
             box-shadow: none !important;
            border-bottom-color: #0d9488;
            outline: none;
        }
        .input-wrapper {
            position: relative;
        }
        .input-unit {
            position: absolute;
            right: 0;
            bottom: 8px;
            color: #6b7280;
            pointer-events: none;
        }
        .result-value {
            font-size: 1.5rem; /* 24px */
            font-weight: bold;
            word-break: break-all;
            line-height: 1.2;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto px-4 py-8">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-teal-700">ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–Webåºƒå‘Šäºˆç®—ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>
            <p class="mt-2 text-lg text-gray-600">éå»ãƒ‡ãƒ¼ã‚¿ãŒãªã„çŠ¶æ…‹ã‹ã‚‰ã€è«–ç†çš„ãªåºƒå‘Šäºˆç®—ã¨æˆ¦ç•¥ã‚’ç­–å®šã™ã‚‹</p>
        </header>

        <nav class="bg-white rounded-lg shadow-md p-2 flex flex-wrap justify-center gap-2 mb-8">
            <button data-section="simulator" class="nav-btn nav-active flex-grow sm:flex-grow-0 px-4 py-2 text-sm font-medium rounded-md focus:outline-none transition-colors">äºˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</button>
            <button data-section="case-studies" class="nav-btn nav-inactive flex-grow sm:flex-grow-0 px-4 py-2 text-sm font-medium rounded-md focus:outline-none transition-colors">ã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£</button>
            <button data-section="knowledge" class="nav-btn nav-inactive flex-grow sm:flex-grow-0 px-4 py-2 text-sm font-medium rounded-md focus:outline-none transition-colors">ç”¨èªãƒ»è¨ˆç®—å¼ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹</button>
            <button data-section="benchmarks" class="nav-btn nav-inactive flex-grow sm:flex-grow-0 px-4 py-2 text-sm font-medium rounded-md focus:outline-none transition-colors">æ¥­ç•Œãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯</button>
            <button data-section="optimization" class="nav-btn nav-inactive flex-grow sm:flex-grow-0 px-4 py-2 text-sm font-medium rounded-md focus:outline-none transition-colors">æœ€é©åŒ–ã‚¬ã‚¤ãƒ‰</button>
        </nav>

        <main>
            <section id="simulator" class="content-section">
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">äºˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h2>
                        <p class="text-gray-500 mt-1">çŠ¶æ³ã«åˆã‚ã›ã¦è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã€åºƒå‘Šäºˆç®—ã‚„æˆæœã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚</p>
                    </div>

                    <div class="mb-8 p-1 bg-gray-100 rounded-lg flex flex-col sm:flex-row gap-1 max-w-4xl mx-auto">
                        <button data-mode="A" class="sim-mode-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors whitespace-nowrap">A: ç›®æ¨™åˆ©ç›Šã‹ã‚‰ç®—å‡º</button>
                        <button data-mode="B" class="sim-mode-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors whitespace-nowrap">B: ç›®æ¨™å£²ä¸Šã‹ã‚‰ç®—å‡º</button>
                        <button data-mode="C" class="sim-mode-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors whitespace-nowrap">C: äºˆç®—ã‹ã‚‰æˆæœã‚’äºˆæ¸¬</button>
                        <button data-mode="D" class="sim-mode-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors whitespace-nowrap">D: KPIç›®æ¨™ã‹ã‚‰é€†ç®—</button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                        
                        <!-- Left Column: Inputs -->
                        <div class="lg:col-span-3 space-y-8">
                            <div class="space-y-6">
                                <div id="mode-A-inputs" class="input-group space-y-6">
                                    <h3 class="text-lg font-semibold text-gray-800">ãƒ¢ãƒ¼ãƒ‰A: å¿…é ˆé …ç›®</h3>
                                    <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">ç›®æ¨™åˆ©ç›Š (æœˆ)</label><input type="number" id="a-targetProfit" class="simulator-input custom-input mt-1 block w-full" placeholder="500000"><span class="input-unit">å††</span></div>
                                    <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å¹³å‡é¡§å®¢å˜ä¾¡ (LTV)</label><input type="number" id="a-avgCustomerValue" class="simulator-input custom-input mt-1 block w-full" placeholder="10000"><span class="input-unit">å††</span></div>
                                    <div>
                                        <label for="a-cost-type" class="block text-sm font-medium text-gray-700">åŸä¾¡ã®å…¥åŠ›æ–¹æ³•</label>
                                        <select id="a-cost-type" class="simulator-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                                            <option value="cogs">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²» (å††)</option>
                                            <option value="margin">åŸä¾¡ç‡ (%)</option>
                                        </select>
                                    </div>
                                    <div id="a-cogs-wrapper" class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²»</label><input type="number" id="a-cogs" class="simulator-input custom-input mt-1 block w-full" placeholder="4000"><span class="input-unit">å††</span></div>
                                    <div id="a-margin-wrapper" class="hidden input-wrapper"><label class="block text-sm font-medium text-gray-700">åŸä¾¡ç‡ (%)</label><input type="number" id="a-margin" class="simulator-input custom-input mt-1 block w-full" placeholder="40"><span class="input-unit">%</span></div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ç›®æ¨™CPAã®ç®—å‡ºæ–¹æ³•ã‚’é¸æŠ</label>
                                        <div class="flex gap-2">
                                            <button id="a-profit-btn" class="optional-input-btn flex-1 py-2 px-3 text-xs rounded-md">åˆ©ç›Šé¡ã§æŒ‡å®š</button>
                                            <button id="a-roas-btn" class="optional-input-btn flex-1 py-2 px-3 text-xs rounded-md">ç›®æ¨™ROASã§æŒ‡å®š</button>
                                            <button id="a-roi-btn" class="optional-input-btn flex-1 py-2 px-3 text-xs rounded-md">ç›®æ¨™ROIã§æŒ‡å®š</button>
                                        </div>
                                    </div>
                                    <div id="a-profit-wrapper" class="input-wrapper"><label class="block text-sm font-medium text-gray-700">ç¢ºä¿ã—ãŸã„åˆ©ç›Š/CV</label><input type="number" id="a-profitPerCv" class="simulator-input custom-input mt-1 block w-full" placeholder="2000"><span class="input-unit">å††</span></div>
                                    <div id="a-roas-wrapper" class="hidden input-wrapper"><label class="block text-sm font-medium text-gray-700">ç›®æ¨™ROAS (%)</label><input type="number" id="a-targetRoas" class="simulator-input custom-input mt-1 block w-full" placeholder="500"><span class="input-unit">%</span></div>
                                    <div id="a-roi-wrapper" class="hidden input-wrapper"><label class="block text-sm font-medium text-gray-700">ç›®æ¨™ROI (%)</label><input type="number" id="a-targetRoi" class="simulator-input custom-input mt-1 block w-full" placeholder="100"><span class="input-unit">%</span></div>
                                </div>
                               <div id="mode-B-inputs" class="input-group hidden space-y-6">
                                    <h3 class="text-lg font-semibold text-gray-800">ãƒ¢ãƒ¼ãƒ‰B: å¿…é ˆé …ç›®</h3>
                                    <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">ç›®æ¨™å£²ä¸Š (æœˆ)</label><input type="number" id="b-targetSales" class="simulator-input custom-input mt-1 block w-full" placeholder="3000000"><span class="input-unit">å††</span></div>
                                    <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å¹³å‡é¡§å®¢å˜ä¾¡</label><input type="number" id="b-avgCustomerValue" class="simulator-input custom-input mt-1 block w-full" placeholder="10000"><span class="input-unit">å††</span></div>
                                    <div>
                                         <label for="b-cost-type" class="block text-sm font-medium text-gray-700">åŸä¾¡ã®å…¥åŠ›æ–¹æ³•</label>
                                        <select id="b-cost-type" class="simulator-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                                            <option value="cogs">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²» (å††)</option>
                                            <option value="margin">åŸä¾¡ç‡ (%)</option>
                                        </select>
                                    </div>
                                    <div id="b-cogs-wrapper" class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²»</label><input type="number" id="b-cogs" class="simulator-input custom-input mt-1 block w-full" placeholder="4000"><span class="input-unit">å††</span></div>
                                    <div id="b-margin-wrapper" class="hidden input-wrapper"><label class="block text-sm font-medium text-gray-700">åŸä¾¡ç‡ (%)</label><input type="number" id="b-margin" class="simulator-input custom-input mt-1 block w-full" placeholder="40"><span class="input-unit">%</span></div>
                                </div>
                                <div id="mode-C-inputs" class="input-group hidden space-y-6">
                                    <h3 class="text-lg font-semibold text-gray-800">ãƒ¢ãƒ¼ãƒ‰C: å¿…é ˆé …ç›®</h3>
                                    <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">æŠ•ä¸‹å¯èƒ½äºˆç®— (æœˆ)</label><input type="number" id="c-availableBudget" class="simulator-input custom-input mt-1 block w-full" placeholder="1000000"><span class="input-unit">å††</span></div>
                                    <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å¹³å‡é¡§å®¢å˜ä¾¡</label><input type="number" id="c-avgCustomerValue" class="simulator-input custom-input mt-1 block w-full" placeholder="10000"><span class="input-unit">å††</span></div>
                                    <div>
                                        <label for="c-cost-type" class="block text-sm font-medium text-gray-700">åŸä¾¡ã®å…¥åŠ›æ–¹æ³•</label>
                                        <select id="c-cost-type" class="simulator-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                                            <option value="cogs">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²» (å††)</option>
                                            <option value="margin">åŸä¾¡ç‡ (%)</option>
                                        </select>
                                    </div>
                                    <div id="c-cogs-wrapper" class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²»</label><input type="number" id="c-cogs" class="simulator-input custom-input mt-1 block w-full" placeholder="4000"><span class="input-unit">å††</span></div>
                                    <div id="c-margin-wrapper" class="hidden input-wrapper"><label class="block text-sm font-medium text-gray-700">åŸä¾¡ç‡ (%)</label><input type="number" id="c-margin" class="simulator-input custom-input mt-1 block w-full" placeholder="40"><span class="input-unit">%</span></div>
                                </div>
                                 <div id="mode-D-inputs" class="input-group hidden space-y-6">
                                    <h3 class="text-lg font-semibold text-gray-800">ãƒ¢ãƒ¼ãƒ‰D: å¿…é ˆé …ç›®</h3>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·ç‚¹ã‚’é¸æŠ</label>
                                        <div class="flex gap-2">
                                            <button id="d-cv-btn" class="optional-input-btn flex-1 py-2 px-3 text-xs rounded-md">ç›®æ¨™CVæ•°ã‹ã‚‰ç®—å‡º</button>
                                            <button id="d-cpa-btn" class="optional-input-btn flex-1 py-2 px-3 text-xs rounded-md">ç›®æ¨™CPAã‹ã‚‰ç®—å‡º</button>
                                        </div>
                                    </div>
                                    <div id="d-cv-wrapper" class="input-wrapper">
                                        <label class="block text-sm font-medium text-gray-700">ç›®æ¨™CVæ•°</label><input type="number" id="d-targetCv" class="simulator-input custom-input mt-1 block w-full" placeholder="100"><span class="input-unit">ä»¶</span>
                                    </div>
                                    <div id="d-cpa-wrapper" class="hidden space-y-6">
                                          <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">ç›®æ¨™CPA</label><input type="number" id="d-targetCpa" class="simulator-input custom-input mt-1 block w-full" placeholder="15000"><span class="input-unit">å††</span></div>
                                          <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">ç›®æ¨™åˆ©ç›Š</label><input type="number" id="d-targetProfit" class="simulator-input custom-input mt-1 block w-full" placeholder="500000"><span class="input-unit">å††</span></div>
                                    </div>
                                    <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å¹³å‡é¡§å®¢å˜ä¾¡ (LTV)</label><input type="number" id="d-avgCustomerValue" class="simulator-input custom-input mt-1 block w-full" placeholder="10000"><span class="input-unit">å††</span></div>
                                    <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">å•†å“åŸä¾¡ãƒ»å¤‰å‹•è²»</label><input type="number" id="d-cogs" class="simulator-input custom-input mt-1 block w-full" placeholder="4000"><span class="input-unit">å††</span></div>
                                </div>

                                <div class="pt-6 border-t">
                                    <h3 class="text-lg font-semibold text-gray-700 mb-4">å…±é€šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹äºˆæ¸¬</h3>
                                    <div class="space-y-6">
                                        <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">æ¨å®šCVR (%)</label><input type="number" id="common-cvr" class="simulator-input custom-input mt-1 block w-full" placeholder="1.0" step="0.1"><span class="input-unit">%</span></div>
                                        <div class="input-wrapper"><label class="block text-sm font-medium text-gray-700">æ¨å®šCPC (å††)</label><input type="number" id="common-cpc" class="simulator-input custom-input mt-1 block w-full" placeholder="200"><span class="input-unit">å††</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column: Results -->
                        <div class="lg:col-span-2">
                            <div class="bg-teal-50/50 p-6 rounded-lg space-y-4 sticky top-8">
                                <h3 id="results-title" class="text-lg font-semibold text-center text-teal-800">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</h3>
                                <div id="results-main" class="grid grid-cols-2 gap-4"></div>
                                <div id="results-scenario" class="pt-4"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-12">
                       <div class="chart-container">
                           <canvas id="budgetChart"></canvas>
                       </div>
                    </div>
                    
                    <div id="ai-section" class="mt-12 pt-8 border-t-2 border-teal-100">
                         <div class="text-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center justify-center gap-2">ğŸ¤– AIã«ã‚ˆã‚‹ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¢ã‚·ã‚¹ãƒˆ</h2>
                            <p class="text-gray-500 mt-1">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’åŸºã«ã€å…·ä½“çš„ãªåºƒå‘Šæˆ¦ç•¥ã‚’AIãŒææ¡ˆã—ã¾ã™ã€‚</p>
                        </div>
                        <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow">
                            <div>
                                <label for="productDescription" class="block text-sm font-medium text-gray-700">å®£ä¼ã—ãŸã„å•†å“ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã‚’å…·ä½“çš„ã«å…¥åŠ›ã—ã¦ãã ã•ã„</label>
                                <textarea id="productDescription" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" placeholder="ä¾‹: æ±äº¬ãƒ»æ¸‹è°·ã«ã‚ã‚‹ã€åˆå¿ƒè€…å‘ã‘ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¸ãƒ ã€‚å®Œå…¨å€‹å®¤ã§ã€ä¸€äººã²ã¨ã‚Šã«åˆã‚ã›ãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ©ãƒ³ã‚’æä¾›ã€‚"></textarea>
                            </div>
                            <div class="mt-4">
                                <label for="adUrl" class="block text-sm font-medium text-gray-700">åºƒå‘Šã§ä½¿ç”¨ã™ã‚‹URL <span class="text-xs text-gray-500">(ä»»æ„)</span></label>
                                <input type="url" id="adUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" placeholder="https://example.com/product-page">
                                <p class="mt-1 text-xs text-gray-500">URLã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãƒšãƒ¼ã‚¸ã®å†…å®¹ã‚’è€ƒæ…®ã—ãŸææ¡ˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
                            </div>
                            <div class="mt-4 flex flex-col sm:flex-row gap-4">
                                <button id="generateCopyBtn" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">åºƒå‘Šã‚³ãƒ”ãƒ¼ã‚’ç”Ÿæˆ âœ¨</button>
                                <button id="generateTargetingBtn" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-base font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°æ¡ˆã‚’ç”Ÿæˆ ğŸ¯</button>
                            </div>
                        </div>
                        <div id="aiResultContainer" class="mt-6 max-w-4xl mx-auto"></div>
                    </div>
                </div>
            </section>

            <section id="case-studies" class="content-section hidden"><div class="bg-white p-6 rounded-xl shadow-lg"><div class="text-center mb-6"><h2 class="text-2xl font-bold text-gray-800">ã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£</h2><p class="text-gray-500 mt-1">äº‹ä¾‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚</p></div><div id="caseStudiesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div></section>
            
            <section id="knowledge" class="content-section hidden">
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800">ç”¨èªãƒ»è¨ˆç®—å¼ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹</h2>
                        <p class="text-gray-500 mt-2">åºƒå‘Šäºˆç®—ã®ç­–å®šã«å¿…è¦ãªä¸»è¦ãªæŒ‡æ¨™ã¨è¨ˆç®—å¼ã®ä¸€è¦§ã§ã™ã€‚</p>
                        <div class="mt-4 space-y-2"><div class="formula">å¿…è¦åºƒå‘Šäºˆç®— = å¿…è¦CVæ•° Ã— ç›®æ¨™CPA</div></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="benchmarks" class="content-section hidden"><div class="bg-white p-6 rounded-xl shadow-lg"><div class="text-center mb-6"><h2 class="text-2xl font-bold text-gray-800">æ¥­ç•Œãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯</h2><p class="text-gray-500 mt-1">å„ç¨®åºƒå‘Šãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®æ¥­ç•Œåˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ã§ã™ã€‚â€»å„èª¿æŸ»ä¼šç¤¾ã®å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã—ãŸå‚è€ƒå€¤ã§ã™ã€‚</p></div><div><div class="border-b border-gray-200"><nav id="benchmarkTabs" class="-mb-px flex flex-wrap space-x-6" aria-label="Tabs"></nav></div><div id="benchmarkContent" class="mt-6"></div></div></div></section>
            <section id="optimization" class="content-section hidden"><div class="bg-white p-6 rounded-xl shadow-lg"><div class="text-center mb-6"><h2 class="text-2xl font-bold text-gray-800">æœ€é©åŒ–ã‚¬ã‚¤ãƒ‰</h2><p class="text-gray-500 mt-1">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é–‹å§‹å¾Œã«ã‚ˆãã‚ã‚‹å•é¡Œã¨ãã®å¯¾å‡¦æ³•ã€‚</p></div><div class="max-w-3xl mx-auto space-y-4" id="accordionContainer"></div></div></section>
        </main>
    </div>
    
    <div id="tooltip">
        <h4 id="tooltip-title"></h4>
        <p id="tooltip-desc"></p>
        <div id="tooltip-formula" class="formula"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const data = {
        caseStudies: [
             // 1åˆ—ç›®: ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹
            { id: 'fitness-24h', title: 'ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹', subtitle: '24æ™‚é–“å–¶æ¥­ã‚¸ãƒ ', targetProfit: 600000, avgCustomerValue: 38400, cogs: 0, profitPerCv: 8000, targetRoi: 26.3, cvr: 3.5, cpc: 250, description: 'é§…è¿‘ã§ä¾¿åˆ©ãª24æ™‚é–“å–¶æ¥­ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚¸ãƒ ã€‚æœ€æ–°ãƒã‚·ãƒ³å®Œå‚™ã§ã€æœˆé¡8,000å††ã‹ã‚‰åˆ©ç”¨å¯èƒ½ã€‚è¦‹å­¦äºˆç´„å—ä»˜ä¸­ã€‚' },
            { id: 'fitness-yoga', title: 'ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹', subtitle: 'å¥³æ€§å°‚ç”¨ãƒ›ãƒƒãƒˆãƒ¨ã‚¬', targetProfit: 450000, avgCustomerValue: 60000, cogs: 0, profitPerCv: 15000, targetRoi: 33.3, cvr: 2.5, cpc: 180, description: 'åˆå¿ƒè€…æ­“è¿ã®å¥³æ€§å°‚ç”¨ãƒ›ãƒƒãƒˆãƒ¨ã‚¬ã‚¹ã‚¿ã‚¸ã‚ªã€‚ãƒ‡ãƒˆãƒƒã‚¯ã‚¹ã¨ãƒªãƒ©ãƒƒã‚¯ã‚¹åŠ¹æœã§å¿ƒã‚‚ä½“ã‚‚ç¾ã—ãã€‚ä½“é¨“ãƒ¬ãƒƒã‚¹ãƒ³å—ä»˜ä¸­ã€‚' },
            { id: 'fitness-online', title: 'ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹', subtitle: 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«', targetProfit: 400000, avgCustomerValue: 25000, cogs: 0, profitPerCv: 10000, targetRoi: 66.7, cvr: 2.0, cpc: 400, description: 'è‡ªå®…ã§å—ã‘ã‚‰ã‚Œã‚‹æœ¬æ ¼çš„ãªã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€‚ã‚ãªãŸå°‚ç”¨ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ç†æƒ³ã®èº«ä½“ã¸ã€‚ç„¡æ–™ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°å®Ÿæ–½ä¸­ã€‚' },
            // 2åˆ—ç›®: å­¦ç¿’å¡¾
            { id: 'tutor-elem', title: 'å­¦ç¿’å¡¾', subtitle: 'å°å­¦ç”Ÿå‘ã‘é›†å›£æŒ‡å°', targetProfit: 500000, avgCustomerValue: 48000, cogs: 0, profitPerCv: 10000, targetRoi: 26.3, cvr: 1.5, cpc: 300, description: 'åœ°åŸŸå¯†ç€å‹ã®å°å­¦ç”Ÿå‘ã‘å­¦ç¿’å¡¾ã€‚ã‚ã‹ã‚‹ã¾ã§å¾¹åº•æŒ‡å°ã§ã€å‹‰å¼·ãŒæ¥½ã—ããªã‚‹ã€‚ã¾ãšã¯è³‡æ–™è«‹æ±‚ã‹ã‚‰ã€‚' },
            { id: 'tutor-univ', title: 'å­¦ç¿’å¡¾', subtitle: 'å¤§å­¦å—é¨“äºˆå‚™æ ¡', targetProfit: 1350000, avgCustomerValue: 150000, cogs: 0, profitPerCv: 45000, targetRoi: 42.9, cvr: 2.5, cpc: 550, description: 'é›£é–¢å¤§å­¦ã‚’ç›®æŒ‡ã™é«˜æ ¡ç”Ÿã®ãŸã‚ã®å¤§å­¦å—é¨“äºˆå‚™æ ¡ã€‚ãƒ—ãƒ­è¬›å¸«é™£ã«ã‚ˆã‚‹è³ªã®é«˜ã„æˆæ¥­ã¨æ‰‹åšã„ã‚µãƒãƒ¼ãƒˆã€‚å€‹åˆ¥ç›¸è«‡ä¼šã‚’äºˆç´„ã€‚' },
            { id: 'tutor-prog', title: 'å­¦ç¿’å¡¾', subtitle: 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¹ã‚¯ãƒ¼ãƒ«', targetProfit: 1000000, avgCustomerValue: 60000, cogs: 0, profitPerCv: 20000, targetRoi: 50, cvr: 3.0, cpc: 700, description: 'æœªçµŒé¨“ã‹ã‚‰ITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¸ã€‚è»¢è·ä¿è¨¼ä»˜ãã®ç¤¾ä¼šäººå‘ã‘ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¹ã‚¯ãƒ¼ãƒ«ã€‚ã¾ãšã¯ç„¡æ–™ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°ã¸ã€‚' },
            // 3åˆ—ç›®: è²·å–ã‚µãƒ¼ãƒ“ã‚¹
            { id: 'buyback-brand', title: 'è²·å–ã‚µãƒ¼ãƒ“ã‚¹', subtitle: 'ãƒ–ãƒ©ãƒ³ãƒ‰å“å®…é…è²·å–', targetProfit: 400000, avgCustomerValue: 9000, cogs: 0, profitPerCv: 4000, targetRoi: 80, cvr: 5.0, cpc: 400, description: 'é€æ–™ç„¡æ–™ã€æ‰‹æ•°æ–™ç„¡æ–™ã®ãƒ–ãƒ©ãƒ³ãƒ‰å“å®…é…è²·å–ã‚µãƒ¼ãƒ“ã‚¹ã€‚ç®±ã«è©°ã‚ã¦é€ã‚‹ã ã‘ã§ç°¡å˜æŸ»å®šã€‚å®…é…ã‚­ãƒƒãƒˆã‚’ç”³ã—è¾¼ã‚€ã€‚' },
            { id: 'buyback-car', title: 'è²·å–ã‚µãƒ¼ãƒ“ã‚¹', subtitle: 'ä¸­å¤è»Šä¸€æ‹¬æŸ»å®š', targetProfit: 1000000, avgCustomerValue: 5000, cogs: 0, profitPerCv: 2000, targetRoi: 66.7, cvr: 8.0, cpc: 600, description: 'æ„›è»Šã®æœ€é«˜é¡ãŒã‚ã‹ã‚‹ï¼è¤‡æ•°ã®è²·å–æ¥­è€…ã«ä¸€æ‹¬ã§æŸ»å®šã‚’ä¾é ¼ã§ãã‚‹ç„¡æ–™ã‚µãƒ¼ãƒ“ã‚¹ã€‚' },
            { id: 'buyback-book', title: 'è²·å–ã‚µãƒ¼ãƒ“ã‚¹', subtitle: 'å¤æœ¬ãƒ»ã‚²ãƒ¼ãƒ å‡ºå¼µè²·å–', targetProfit: 160000, avgCustomerValue: 3600, cogs: 0, profitPerCv: 1600, targetRoi: 80, cvr: 4.0, cpc: 150, description: 'æœ¬ãƒ»æ¼«ç”»ãƒ»ã‚²ãƒ¼ãƒ ã€30ç‚¹ã‹ã‚‰ç„¡æ–™ã§å‡ºå¼µè²·å–ã€‚ç„é–¢å…ˆã§æŸ»å®šã€ãã®å ´ã§ç¾é‡‘æ‰•ã„ã€‚' },
            // 4åˆ—ç›®: ä¸å‹•ç”£
            { id: 'real-estate', title: 'ä¸å‹•ç”£', subtitle: 'è³ƒè²¸ä»²ä»‹ï¼ˆå•ã„åˆã‚ã›ï¼‰', targetProfit: 600000, avgCustomerValue: 30000, cogs: 0, profitPerCv: 15000, targetRoi: 100, cvr: 2.5, cpc: 300, description: 'éƒ½å¿ƒã‚¨ãƒªã‚¢ã®å˜èº«è€…å‘ã‘è³ƒè²¸ç‰©ä»¶ã‚’å°‚é–€ã«æ‰±ã†ä¸å‹•ç”£ä»²ä»‹ã‚µãƒ¼ãƒ“ã‚¹ã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å†…è¦‹ã«ã‚‚å¯¾å¿œã€‚' },
            { id: 'real-estate-invest', title: 'ä¸å‹•ç”£', subtitle: 'æŠ•è³‡ç”¨ç‰©ä»¶ï¼ˆè³‡æ–™è«‹æ±‚ï¼‰', targetProfit: 2000000, avgCustomerValue: 10000, cogs: 0, profitPerCv: 5000, targetRoi: 100, cvr: 1.0, cpc: 800, description: 'å°†æ¥ã®ãŸã‚ã®è³‡ç”£å½¢æˆã€‚éƒ½å¿ƒã®ä¸­å¤ãƒãƒ³ã‚·ãƒ§ãƒ³ã‚’ä¸­å¿ƒã¨ã—ãŸæŠ•è³‡ç”¨ä¸å‹•ç”£ã®ã”ææ¡ˆã€‚ã¾ãšã¯ç„¡æ–™ã®è³‡æ–™è«‹æ±‚ã‹ã‚‰ã€‚' },
            { id: 'real-estate-new', title: 'ä¸å‹•ç”£', subtitle: 'æ–°ç¯‰æˆ¸å»ºã¦ï¼ˆè¦‹å­¦äºˆç´„ï¼‰', targetProfit: 1500000, avgCustomerValue: 50000, cogs: 0, profitPerCv: 25000, targetRoi: 100, cvr: 1.5, cpc: 650, description: 'å®¶æ—ã®å¤¢ã‚’å¶ãˆã‚‹ã€ãƒ‡ã‚¶ã‚¤ãƒ³æ€§ã®é«˜ã„æ–°ç¯‰æˆ¸å»ºã¦ã€‚é€±æœ«ã®è¦‹å­¦ä¼šã‚’äºˆç´„ã—ã¦ã€ç†æƒ³ã®ä½ã¾ã„ã‚’ä½“æ„Ÿã—ã¦ãã ã•ã„ã€‚' },
            // 5åˆ—ç›®ä»¥é™: ãã®ä»–
            { id: 'b2c-ec', title: 'B2C Eã‚³ãƒãƒ¼ã‚¹', subtitle: 'ãƒãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ‰ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼', targetProfit: 150000, avgCustomerValue: 5000, cogs: 1000, profitPerCv: 2000, targetRoi: 100, cvr: 1.0, cpc: 120, description: '20ä»£å¥³æ€§å‘ã‘ã®ã€é«˜å“è³ªãªå¤©ç„¶çŸ³ã‚’ä½¿ã£ãŸãƒãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ‰ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ãƒˆã‚¢ã€‚' },
            { id: 'b2b-saas', title: 'B2B SaaS', subtitle: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚½ãƒ•ãƒˆ', targetProfit: 1080000, avgCustomerValue: 60000, cogs: 0, profitPerCv: 24000, targetRoas: 250, targetRoi: 150, cvr: 2.0, cpc: 600, description: 'ä¸­å°ä¼æ¥­ãƒ»ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—å‘ã‘ã®ç›´æ„Ÿçš„ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†SaaSãƒ„ãƒ¼ãƒ«ã€‚ã‚¿ã‚¹ã‚¯ç®¡ç†ã€ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã€ãƒãƒ¼ãƒ ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’æä¾›ã€‚' },
            { id: 'high-ticket', title: 'é«˜ä¾¡æ ¼å¸¯B2C', subtitle: 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è‹±ä¼šè©±', targetProfit: 1734200, avgCustomerValue: 24000, cogs: 0, profitPerCv: 12333, targetRoi: 105.7, cvr: 3.0, cpc: 350, description: 'ãƒ“ã‚¸ãƒã‚¹ãƒ‘ãƒ¼ã‚½ãƒ³å‘ã‘ã®ãƒãƒ³ãƒ„ãƒ¼ãƒãƒ³ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è‹±ä¼šè©±ã‚¹ã‚¯ãƒ¼ãƒ«ã€‚ãƒã‚¤ãƒ†ã‚£ãƒ–è¬›å¸«ã«ã‚ˆã‚‹é«˜å“è³ªãªãƒ¬ãƒƒã‚¹ãƒ³ãŒç‰¹å¾´ã€‚' }
        ],
        benchmarks: {
            googleSearch: { 
                name: 'Googleæ¤œç´¢', 
                headers: ['æ¥­ç•Œ', 'å¹³å‡CPC', 'å¹³å‡CVR (æ¤œç´¢)', 'å¹³å‡CPA (æ¤œç´¢)'], 
                rows: [ 
                    ['BtoB', '450å†† - 600å††', '3.04%', '15,000å†† - 20,000å††'], 
                    ['Eã‚³ãƒãƒ¼ã‚¹', '150å†† - 300å††', '2.81%', '6,000å†† - 9,000å††'], 
                    ['æ•™è‚²ãƒ»å­¦ç¿’', '250å†† - 400å††', '3.39%', '10,000å†† - 15,000å††'],
                    ['é‡‘èãƒ»ä¿é™º', '350å†† - 800å††', '5.10%', '8,000å†† - 13,000å††'], 
                    ['å¥åº·ãƒ»åŒ»ç™‚', '300å†† - 500å††', '3.36%', '9,000å†† - 12,000å††'],
                    ['ç¾å®¹ãƒ»ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹', '200å†† - 450å††', '3.80%', '7,000å†† - 11,000å††'],
                    ['äººæãƒ»æ¡ç”¨', '400å†† - 700å††', '5.13%', '6,000å†† - 9,000å††'],
                    ['ä¸å‹•ç”£', '300å†† - 700å††', '2.47%', '15,000å†† - 20,000å††'],
                    ['ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼', '400å†† - 650å††', '2.92%', '14,000å†† - 22,000å††'],
                    ['æ—…è¡Œãƒ»è¦³å…‰', '150å†† - 300å††', '4.68%', '5,000å†† - 8,000å††'],
                ] 
            },
            meta: { 
                name: 'Metaåºƒå‘Š', 
                headers: ['æ¥­ç•Œ', 'å¹³å‡CPC', 'å¹³å‡CVR', 'å¹³å‡CPA'], 
                rows: [ 
                    ['ã‚¢ãƒ‘ãƒ¬ãƒ«ãƒ»EC', '80å†† - 200å††', '4.11%', '1,200å†† - 3,000å††'], 
                    ['ç¾å®¹ãƒ»ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹', '100å†† - 300å††', '11.29%', '2,500å†† - 5,000å††'], 
                    ['æ•™è‚²ãƒ»å­¦ç¿’', '150å†† - 400å††', '13.58%', '8,000å†† - 15,000å††'], 
                    ['é‡‘èãƒ»ä¿é™º', '300å†† - 700å††', '9.09%', '18,000å†† - 25,000å††'], 
                    ['BtoB', '250å†† - 500å††', '10.63%', '10,000å†† - 20,000å††'], 
                    ['ä¸å‹•ç”£', '200å†† - 600å††', '10.67%', '10,000å†† - 18,000å††'],
                    ['åŒ»ç™‚ãƒ»å¥åº·', '180å†† - 450å††', '11.00%', '7,000å†† - 13,000å††'],
                    ['äººæãƒ»æ¡ç”¨', '150å†† - 350å††', '9.50%', '5,000å†† - 10,000å††'],
                    ['æ—…è¡Œãƒ»è¦³å…‰', '70å†† - 180å††', '5.50%', '3,000å†† - 6,000å††'],
                ] 
            },
            x: { 
                name: 'X (æ—§Twitter)', 
                headers: ['æŒ‡æ¨™', 'å¹³å‡å€¤ï¼ˆç›®å®‰ï¼‰', 'å‚™è€ƒ'], 
                rows: [
                    ['CPC (ã‚¯ãƒªãƒƒã‚¯å˜ä¾¡)', '40å†† - 120å††', 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç›®çš„ã«ã‚ˆã‚Šå¤§ããå¤‰å‹•'],
                    ['CPM (ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³å˜ä¾¡)', '600å†† - 900å††', 'ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ã§å¤‰å‹•'],
                    ['CPE (ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆå˜ä¾¡)', '30å†† - 70å††', 'ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç›®çš„ã®å ´åˆ'],
                    ['CVR (ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡)', '0.5% - 2.0%', 'å•†å“ã‚„è¨´æ±‚å†…å®¹ã«å¤§ããä¾å­˜'],
                    ['CPI (ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å˜ä¾¡)', '150å†† - 400å††', 'ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«åºƒå‘Šã®å ´åˆ'],
                ]
            },
            tiktok: {
                name: 'TikTokåºƒå‘Š',
                headers: ['æŒ‡æ¨™', 'å¹³å‡å€¤ï¼ˆç›®å®‰ï¼‰', 'å‚™è€ƒ'],
                rows: [
                    ['CPM (ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³å˜ä¾¡)', '200å†† - 800å††', 'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã®è³ªã§å¤§ããå¤‰å‹•'],
                    ['CPC (ã‚¯ãƒªãƒƒã‚¯å˜ä¾¡)', '30å†† - 100å††', 'è‹¥å¹´å±¤å‘ã‘å•†æã§åŠ¹ç‡ãŒè‰¯ã„å‚¾å‘'],
                    ['CVR (ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡)', '0.5% - 3.0%', 'å‹•ç”»ã®å†’é ­ã§èˆˆå‘³ã‚’å¼•ãã“ã¨ãŒé‡è¦'],
                    ['CPV (è¦–è´å˜ä¾¡)', '3å†† - 10å††', 'å‹•ç”»è¦–è´ç›®çš„ã®å ´åˆ'],
                ]
            },
            line: { 
                name: 'LINEåºƒå‘Š', 
                headers: ['èª²é‡‘æ–¹å¼', 'è²»ç”¨æ„Ÿã®ç›®å®‰', 'ç‰¹å¾´'], 
                rows: [ 
                    ['ã‚¯ãƒªãƒƒã‚¯èª²é‡‘ (CPC)', '30å††ï½150å††', 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã¸ã®èª˜å°ã«æœ€é©'], 
                    ['ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³èª²é‡‘ (CPM)', '500å††ï½1,200å††', 'å¹…åºƒã„èªçŸ¥ç²å¾—å‘ã‘'], 
                    ['å‹ã ã¡è¿½åŠ èª²é‡‘ (CPF)', '100å††ï½300å††', 'è¦‹è¾¼ã¿é¡§å®¢ãƒªã‚¹ãƒˆã®æ§‹ç¯‰ã«æœ€é©'], 
                ] 
            }
        },
        optimization: [
            { title: 'å•é¡Œï¼šCTRï¼ˆã‚¯ãƒªãƒƒã‚¯ç‡ï¼‰ãŒä½ã„', content: `<strong>åŸå› ï¼š</strong>åºƒå‘Šæ–‡ãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«éŸ¿ã„ã¦ã„ãªã„ã€ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ãŒåºƒã™ãã‚‹ã€åºƒå‘Šã¨æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®é–¢é€£æ€§ãŒä½ã„ã€ãªã©ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚<br><br><strong>è§£æ±ºç­–ï¼š</strong><br>1. <strong>A/Bãƒ†ã‚¹ãƒˆã®å®Ÿæ–½ï¼š</strong>åºƒå‘Šã®è¦‹å‡ºã—ã‚„èª¬æ˜æ–‡ã‚’è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ç”¨æ„ã—ã€ã©ã¡ã‚‰ãŒã‚ˆã‚Šé«˜ã„CTRã‚’ç²å¾—ã§ãã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚<br>2. <strong>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®è¦‹ç›´ã—ï¼š</strong>é–¢é€£æ€§ã®ä½ã„æ¤œç´¢èªå¥ã‚’é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã—ã¦è¨­å®šã—ã€ãƒãƒƒãƒã‚¿ã‚¤ãƒ—ã‚’ã‚ˆã‚Šå…·ä½“çš„ã«çµã‚Šè¾¼ã¿ã¾ã™ã€‚<br>3. <strong>åºƒå‘Šè¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ´»ç”¨ï¼š</strong>ã‚µã‚¤ãƒˆãƒªãƒ³ã‚¯ãªã©ã‚’è¿½åŠ ã—ã€åºƒå‘Šã®è¡¨ç¤ºé¢ç©ã‚’åºƒã’ã€ã‚ˆã‚Šå¤šãã®æƒ…å ±ã‚’æä¾›ã—ã¾ã™ã€‚` },
            { title: 'å•é¡Œï¼šCVRï¼ˆã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ï¼‰ãŒä½ã„', content: `<strong>åŸå› ï¼š</strong>åºƒå‘Šã®è¨´æ±‚å†…å®¹ã¨ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ï¼ˆLPï¼‰ã®å†…å®¹ãŒä¸€è‡´ã—ã¦ã„ãªã„ã€LPã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ï¼ˆUXï¼‰ãŒæ‚ªã„ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãŒè¤‡é›‘ã€è¡¨ç¤ºé€Ÿåº¦ãŒé…ã„ãªã©ï¼‰ã€CTAï¼ˆè¡Œå‹•å–šèµ·ï¼‰ãŒå¼±ã„ã€ãªã©ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚<br><br><strong>è§£æ±ºç­–ï¼š</strong><br>1. <strong>LPã®æœ€é©åŒ–ï¼ˆLPOï¼‰ï¼š</strong>åºƒå‘Šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨LPã®ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ã‚’ä¸€è‡´ã•ã›ã€ä¸€è²«æ€§ã‚’ä¿ã¡ã¾ã™ã€‚<br>2. <strong>å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®æœ€é©åŒ–ï¼ˆEFOï¼‰ï¼š</strong>å…¥åŠ›é …ç›®ã‚’æœ€å°é™ã«æ¸›ã‚‰ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è² æ‹…ã‚’è»½æ¸›ã—ã¾ã™ã€‚<br>3. <strong>CTAã®æ”¹å–„ï¼š</strong>ã€Œé€ä¿¡ã€ã§ã¯ãªãã€ã€Œç„¡æ–™ã§ä½“é¨“ãƒ¬ãƒƒã‚¹ãƒ³ã‚’äºˆç´„ã™ã‚‹ã€ãªã©ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒªãƒƒãƒˆã‚’å…·ä½“çš„ã«ç¤ºã™æ–‡è¨€ã«ä¿®æ­£ã—ã¾ã™ã€‚` },
            { title: 'å•é¡Œï¼šCPAï¼ˆé¡§å®¢ç²å¾—å˜ä¾¡ï¼‰ãŒé«˜ã„', content: `<strong>åŸå› ï¼š</strong>CPAã¯ <strong>CPC Ã· CVR</strong> ã§ç®—å‡ºã•ã‚Œã‚‹ãŸã‚ã€CPAãŒé«˜ã„ã®ã¯ã€ŒCPCãŒé«˜ã™ãã‚‹ã€ã‹ã€ŒCVRãŒä½ã™ãã‚‹ã€ã€ã‚ã‚‹ã„ã¯ãã®ä¸¡æ–¹ãŒåŸå› ã§ã™ã€‚<br><br><strong>è§£æ±ºç­–ï¼š</strong><br>1. <strong>æ ¹æœ¬åŸå› ã¸ã®å¯¾å‡¦ï¼š</strong>ä¸Šè¨˜ã®CTRæ”¹å–„ç­–ï¼ˆCPCã«å½±éŸ¿ï¼‰ã¨CVRæ”¹å–„ç­–ã‚’å¾¹åº•çš„ã«å®Ÿè¡Œã—ã¾ã™ã€‚<br>2. <strong>å“è³ªã‚¹ã‚³ã‚¢ã®å‘ä¸Šï¼š</strong>Googleåºƒå‘Šã§ã¯ã€åºƒå‘Šãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»LPã®é–¢é€£æ€§ã‚’é«˜ã‚ã‚‹ã“ã¨ã§å“è³ªã‚¹ã‚³ã‚¢ãŒå‘ä¸Šã—ã€çµæœã¨ã—ã¦CPCãŒä½ä¸‹ã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚<br>3. <strong>é…ä¿¡ã®æœ€é©åŒ–ï¼š</strong>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ‚ªã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ã¸ã®äºˆç®—é…åˆ†ã‚’æ¸›ã‚‰ã—ã€é€†ã«CPAãŒè‰¯å¥½ãªé ˜åŸŸã«äºˆç®—ã‚’é›†ä¸­ã•ã›ã¾ã™ã€‚` }
        ]
    };

    // Tooltip data
    const tooltipData = {
        'limit-cpa': { title: 'é™ç•ŒCPA', desc: '1CVã‚ãŸã‚Šã«ã‹ã‘ã‚‰ã‚Œã‚‹åºƒå‘Šè²»ã®ä¸Šé™é¡ã€‚ã“ã‚Œã‚’è¶…ãˆã‚‹ã¨èµ¤å­—ã«ãªã‚‹æç›Šåˆ†å²ç‚¹ã§ã™ã€‚', formula: 'å¹³å‡é¡§å®¢å˜ä¾¡ - å•†å“åŸä¾¡' },
        'target-cpa': { title: 'ç›®æ¨™CPA', desc: 'ç›®æ¨™åˆ©ç›Šã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã€1CVã‚ãŸã‚Šã«è¨±å®¹ã•ã‚Œã‚‹åºƒå‘Šè²»ã€‚å£²ä¸Šç›®æ¨™ï¼ˆãƒ¢ãƒ¼ãƒ‰Bï¼‰ã®å ´åˆã¯ã€é™ç•ŒCPAã¨åŒã˜ã«ãªã‚Šã¾ã™ã€‚', formula: 'é™ç•ŒCPA - ç¢ºä¿ã—ãŸã„åˆ©ç›Š/CV<br>ã¾ãŸã¯<br>å¹³å‡é¡§å®¢å˜ä¾¡ / (ç›®æ¨™ROAS / 100)<br>ã¾ãŸã¯<br>(å¹³å‡é¡§å®¢å˜ä¾¡ - åŸä¾¡) / (ç›®æ¨™ROI/100 + 1)' },
        'required-cv': { title: 'å¿…è¦CVæ•°', desc: 'è¨­å®šã—ãŸç›®æ¨™ï¼ˆåˆ©ç›Šã¾ãŸã¯å£²ä¸Šï¼‰ã‚’é”æˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªCVã®ä»¶æ•°ã§ã™ã€‚', formula: 'ç›®æ¨™åˆ©ç›Š Ã· (1CVã‚ãŸã‚Šã®åˆ©ç›Š)<br>ã¾ãŸã¯<br>ç›®æ¨™å£²ä¸Š Ã· å¹³å‡é¡§å®¢å˜ä¾¡' },
        'required-budget': { title: 'å¿…è¦åºƒå‘Šäºˆç®—', desc: 'å¿…è¦CVæ•°ã‚’ã€äºˆæ¸¬ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆCVR, CPCï¼‰ã§é”æˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªåºƒå‘Šè²»ã®ç·é¡ã§ã™ã€‚', formula: 'å¿…è¦CVæ•° Ã— æ¨å®šCPA' },
        'estimated-cpa': { title: 'æ¨å®šCPA', desc: 'å…¥åŠ›ã•ã‚ŒãŸäºˆæ¸¬ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆCVR, CPCï¼‰ã‹ã‚‰ç®—å‡ºã•ã‚Œã‚‹ã€ç¾å®Ÿçš„ãªCPAã®è¦‹ç©ã‚‚ã‚Šã§ã™ã€‚', formula: 'æ¨å®šCPC Ã· (æ¨å®šCVR / 100)' },
        'projected-profit': { title: 'äºˆæ¸¬åˆ©ç›Š', desc: 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸Šã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆæ¨å®šCPAï¼‰ã§ç›®æ¨™ã‚’é”æˆã—ãŸå ´åˆã«è¦‹è¾¼ã¾ã‚Œã‚‹ã€æœ€çµ‚çš„ãªåˆ©ç›Šé¡ã§ã™ã€‚ç›®æ¨™åˆ©ç›Šã¨ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚', formula: '(é™ç•ŒCPA - æ¨å®šCPA) Ã— å¿…è¦CVæ•°' },
        'projected-cv': { title: 'äºˆæ¸¬CVæ•°', desc: 'æŠ•ä¸‹å¯èƒ½äºˆç®—ã§ç²å¾—ãŒæœŸå¾…ã§ãã‚‹CVã®ä»¶æ•°ã§ã™ã€‚', formula: 'æŠ•ä¸‹å¯èƒ½äºˆç®— Ã· æ¨å®šCPA' },
        'projected-sales': { title: 'äºˆæ¸¬å£²ä¸Š', desc: 'äºˆæ¸¬CVæ•°ã‹ã‚‰è¦‹è¾¼ã¾ã‚Œã‚‹å£²ä¸Šé¡ã§ã™ã€‚', formula: 'äºˆæ¸¬CVæ•° Ã— å¹³å‡é¡§å®¢å˜ä¾¡' },
        'projected-roi': { title: 'äºˆæ¸¬ROI (%)', desc: 'æŠ•ä¸‹ã—ãŸåºƒå‘Šäºˆç®—ã«å¯¾ã—ã¦ã€ã©ã‚Œã ã‘ã®åˆ©ç›ŠãŒç”Ÿã¾ã‚Œã‚‹ã‹ã®äºˆæ¸¬å€¤ï¼ˆæŠ•è³‡åˆ©ç›Šç‡ï¼‰ã§ã™ã€‚', formula: '(äºˆæ¸¬åˆ©ç›Š Ã· æŠ•ä¸‹å¯èƒ½äºˆç®—) Ã— 100' }
    };

    const navButtons = document.querySelectorAll('.nav-btn');
    const contentSections = document.querySelectorAll('.content-section');
    const simModeButtons = document.querySelectorAll('.sim-mode-btn');
    const simulatorInputs = document.querySelectorAll('.simulator-input');
    const generateCopyBtn = document.getElementById('generateCopyBtn');
    const generateTargetingBtn = document.getElementById('generateTargetingBtn');
    const aiResultContainer = document.getElementById('aiResultContainer');
    const productDescriptionInput = document.getElementById('productDescription');
    const adUrlInput = document.getElementById('adUrl');
    const resultsMain = document.getElementById('results-main');
    const resultsScenario = document.getElementById('results-scenario');
    const tooltip = document.getElementById('tooltip');
    
    let budgetChart;
    let currentMode = 'A';
    let modeA_cpa_calc_method = 'profit';
    let modeD_kpi_choice = 'cv';

    function formatCurrency(value) { return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(Math.round(value)); }
    function formatNumber(value) { return new Intl.NumberFormat('ja-JP').format(Math.round(value)); }

    function calculateAll() {
        switch (currentMode) {
            case 'A': calculateModeA(); break;
            case 'B': calculateModeB(); break;
            case 'C': calculateModeC(); break;
            case 'D': calculateModeD(); break;
        }
    }

    function createInfoIcon(metric) {
        return `<span class="info-icon ml-1 inline-block align-middle" data-metric="${metric}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071a.499.499 0 0 1-.316-.68l.738-3.468a.499.499 0 0 1 .47-.323c.09-.002.19.022.26.077a.45.45 0 0 1 .15.318l-.305.984h.898c.294 0 .469.176.469.469a.45.45 0 0 1-.15.318l-.305.984h.898c.294 0 .469.176.469.469a.45.45 0 0 1-.15.318l-.305.984h.898c.294 0 .469.176.469.469a.45.45 0 0 1-.15.318l-.305.984h.898c.294 0 .469.176.469.469a.45.45 0 0 1-.15.318l-.305.984H7.284l.29-.071a.499.499 0 0 1 .316-.68l-.738-3.468a.499.499 0 0 1-.47-.323c-.09.002-.19-.022-.26-.077a.45.45 0 0 1-.15-.318l.305-.984H4.93c-.294 0-.469-.176-.469-.469a.45.45 0 0 1 .15-.318l.305-.984H4.93c-.294 0-.469-.176-.469-.469a.45.45 0 0 1 .15-.318l.305-.984H4.93c-.294 0-.469-.176-.469-.469a.45.45 0 0 1 .15-.318l.305-.984H7.284l-.29.071a.499.499 0 0 1-.316.68l.738 3.468a.499.499 0 0 1 .47.323c.09-.002.19.022.26.077a.45.45 0 0 1 .15.318l.305.984h.898c.294 0 .469.176.469.469a.45.45 0 0 1-.15.318l.305.984h.898c.294 0 .469.176.469.469a.45.45 0 0 1-.15.318l.305.984h.898c.294 0 .469.176.469.469a.45.45 0 0 1-.15.318l-.305.984H8.93zM8 4.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                    </svg>
                </span>`;
    }

    function getCogs(prefix) {
        const costTypeSelect = document.getElementById(`${prefix}-cost-type`);
        if (!costTypeSelect) { // Mode D doesn't have cost type selection
            return parseFloat(document.getElementById(`${prefix}-cogs`).value) || 0;
        }
        const costType = costTypeSelect.value;
        const avgCustomerValue = parseFloat(document.getElementById(`${prefix}-avgCustomerValue`).value) || 0;
        if (costType === 'cogs') {
            return parseFloat(document.getElementById(`${prefix}-cogs`).value) || 0;
        } else { // margin
            const margin = parseFloat(document.getElementById(`${prefix}-margin`).value) || 0;
            return avgCustomerValue * (margin / 100);
        }
    }
    
    function renderResults(results, analysisHtml = '') {
        const fullWidthItem = results.find(res => res.fullWidth);
        const gridItems = results.filter(res => !res.fullWidth);
        
        // The container #results-main is already a grid. Just generate the items.
        let html = gridItems.map(res => `
            <div class="bg-white p-3 rounded-md shadow-sm text-center flex flex-col justify-center min-h-[90px]">
                <div class="text-sm text-gray-500 flex items-center justify-center">
                    ${res.label}
                    ${res.metric ? createInfoIcon(res.metric) : ''}
                </div>
                <p class="result-value ${res.color || 'text-gray-800'} mt-1">${res.value}</p>
            </div>
        `).join('');

        if(fullWidthItem) {
            html += `<div class="bg-white p-3 rounded-md shadow-sm text-center mt-4 col-span-2">
                <div class="text-sm text-gray-500 flex items-center justify-center">
                    ${fullWidthItem.label}
                    ${fullWidthItem.metric ? createInfoIcon(fullWidthItem.metric) : ''}
                </div>
                <p class="result-value ${fullWidthItem.color || 'text-gray-800'} mt-1">${fullWidthItem.value}</p>
            </div>`;
        }

        html += analysisHtml;
        
        resultsMain.innerHTML = html;
    }


    function calculateModeA() {
        const targetProfit = parseFloat(document.getElementById('a-targetProfit').value) || 0;
        const avgCustomerValue = parseFloat(document.getElementById('a-avgCustomerValue').value) || 0;
        const cogs = getCogs('a');
        const profitPerCvInput = document.getElementById('a-profitPerCv').value;
        const profitPerCv = profitPerCvInput === '' ? NaN : parseFloat(profitPerCvInput);
        const targetRoas = parseFloat(document.getElementById('a-targetRoas').value) || 0;
        const targetRoi = parseFloat(document.getElementById('a-targetRoi').value) || 0;
        const cvr = parseFloat(document.getElementById('common-cvr').value) || 0;
        const cpc = parseFloat(document.getElementById('common-cpc').value) || 0;

        const limitCpa = avgCustomerValue - cogs;
        let targetCpa;
        let requiredCv;
        let warningMessage = '';
        let profitPerUnit = NaN;

        if (modeA_cpa_calc_method === 'profit') {
            targetCpa = isNaN(profitPerCv) ? NaN : limitCpa - profitPerCv;
            profitPerUnit = profitPerCv;
            if (!isNaN(profitPerCv) && profitPerCv <= 0 && targetProfit > 0) {
                warningMessage = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 col-span-2 mt-2 rounded-r-lg" role="alert"><p class="font-bold">æ³¨æ„</p><p>ã€Œç¢ºä¿ã—ãŸã„åˆ©ç›Š/CVã€ãŒ0å††ä»¥ä¸‹ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ—ãƒ©ã‚¹ã®ç›®æ¨™åˆ©ç›Šã‚’é”æˆã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚</p></div>`;
            }
        } else if (modeA_cpa_calc_method === 'roas') {
             if (targetRoas > 0) {
                targetCpa = avgCustomerValue / (targetRoas / 100);
                profitPerUnit = limitCpa - targetCpa;
                if (profitPerUnit <= 0 && targetProfit > 0) {
                    const breakevenRoas = (avgCustomerValue > 0 && limitCpa > 0) ? (avgCustomerValue / limitCpa) * 100 : 0;
                    warningMessage = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 col-span-2 mt-2 rounded-r-lg" role="alert"><p class="font-bold">æ³¨æ„</p><p>ç›®æ¨™ROASãŒä½ã™ãã‚‹ãŸã‚åˆ©ç›ŠãŒå‡ºã¾ã›ã‚“ã€‚ç›®æ¨™åˆ©ç›Šã®é”æˆã¯ä¸å¯èƒ½ã§ã™ã€‚</p><p class="text-sm mt-2">æç›Šåˆ†å²ROAS (åˆ©ç›ŠãŒ0ã«ãªã‚‹ROAS) ã¯ãŠã‚ˆã <strong>${breakevenRoas.toFixed(1)}%</strong> ã§ã™ã€‚</p></div>`;
                }
            } else {
                targetCpa = NaN;
            }
        } else if (modeA_cpa_calc_method === 'roi') {
            if (targetRoi > -100) { // ROI can be negative, but not <= -100%
                targetCpa = limitCpa / ((targetRoi / 100) + 1);
                profitPerUnit = limitCpa - targetCpa;
                 if (profitPerUnit <= 0 && targetProfit > 0) {
                    warningMessage = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 col-span-2 mt-2 rounded-r-lg" role="alert"><p class="font-bold">æ³¨æ„</p><p>ç›®æ¨™ROIãŒä½ã™ãã‚‹ãŸã‚åˆ©ç›ŠãŒå‡ºã¾ã›ã‚“ã€‚ç›®æ¨™åˆ©ç›Šã®é”æˆã¯ä¸å¯èƒ½ã§ã™ã€‚</p><p class="text-sm mt-2">æç›Šåˆ†å²ROI (åˆ©ç›ŠãŒ0ã«ãªã‚‹ROI) ã¯ <strong>0%</strong> ã§ã™ã€‚</p></div>`;
                }
            } else {
                targetCpa = NaN;
            }
        } else {
            targetCpa = NaN;
        }

        requiredCv = (targetProfit > 0 && profitPerUnit > 0) ? Math.ceil(targetProfit / profitPerUnit) : 0;
        
        const estimatedCpa = cvr > 0 ? cpc / (cvr / 100) : 0;
        const requiredBudget = requiredCv * estimatedCpa;
        const projectedProfit = (limitCpa - estimatedCpa) * requiredCv; // Corrected Profit Calculation

        const resultsData = [
            { label: 'é™ç•ŒCPA', value: formatCurrency(Math.max(0, limitCpa)), color: 'text-red-600', metric: 'limit-cpa' },
            { label: 'ç›®æ¨™CPA', value: isNaN(targetCpa) ? '---' : formatCurrency(Math.max(0, targetCpa)), color: 'text-green-600', metric: 'target-cpa' },
            { label: 'æ¨å®šCPA', value: formatCurrency(estimatedCpa), color: 'text-yellow-600', metric: 'estimated-cpa' },
            { label: 'å¿…è¦CVæ•°', value: `${formatNumber(requiredCv)}ä»¶`, color: 'text-blue-600', metric: 'required-cv' },
            { label: 'å¿…è¦åºƒå‘Šäºˆç®—', value: formatCurrency(requiredBudget), color: 'text-teal-600', metric: 'required-budget' },
            { label: 'äºˆæ¸¬åˆ©ç›Š', value: formatCurrency(projectedProfit), color: 'text-purple-600', metric: 'projected-profit' },
        ];
        renderResults(resultsData, warningMessage);

        renderScenarioSection(requiredCv, cvr, cpc, 'å¿…è¦åºƒå‘Šäºˆç®—', formatCurrency);
    }
    
    function calculateModeB() {
        const targetSales = parseFloat(document.getElementById('b-targetSales').value) || 0;
        const avgCustomerValue = parseFloat(document.getElementById('b-avgCustomerValue').value) || 0;
        const cogs = getCogs('b');
        const cvr = parseFloat(document.getElementById('common-cvr').value) || 0;
        const cpc = parseFloat(document.getElementById('common-cpc').value) || 0;
        
        const requiredCv = (targetSales > 0 && avgCustomerValue > 0) ? Math.ceil(targetSales / avgCustomerValue) : 0;
        const estimatedCpa = cvr > 0 ? cpc / (cvr / 100) : 0;
        const requiredBudget = requiredCv * estimatedCpa;
        const limitCpa = avgCustomerValue - cogs;
        const projectedProfit = (targetSales - (cogs * requiredCv) - requiredBudget);

        const resultsData = [
            { label: 'é™ç•ŒCPA', value: formatCurrency(Math.max(0, limitCpa)), color: 'text-red-600', metric: 'limit-cpa' },
            { label: 'ç›®æ¨™CPA', value: formatCurrency(Math.max(0, limitCpa)), color: 'text-green-600', metric: 'target-cpa' },
            { label: 'æ¨å®šCPA', value: formatCurrency(estimatedCpa), color: 'text-yellow-600', metric: 'estimated-cpa' },
            { label: 'å¿…è¦CVæ•°', value: `${formatNumber(requiredCv)}ä»¶`, color: 'text-blue-600', metric: 'required-cv' },
            { label: 'å¿…è¦åºƒå‘Šäºˆç®—', value: formatCurrency(requiredBudget), color: 'text-teal-600', metric: 'required-budget' },
            { label: 'äºˆæ¸¬åˆ©ç›Š', value: formatCurrency(projectedProfit), color: 'text-purple-600', metric: 'projected-profit' },
        ];
        renderResults(resultsData);
        
        renderScenarioSection(requiredCv, cvr, cpc, 'å¿…è¦åºƒå‘Šäºˆç®—', formatCurrency);
    }

    function calculateModeC() {
        const availableBudget = parseFloat(document.getElementById('c-availableBudget').value) || 0;
        const avgCustomerValue = parseFloat(document.getElementById('c-avgCustomerValue').value) || 0;
        const cogs = getCogs('c');
        const cvr = parseFloat(document.getElementById('common-cvr').value) || 0;
        const cpc = parseFloat(document.getElementById('common-cpc').value) || 0;

        const estimatedCpa = cvr > 0 ? cpc / (cvr / 100) : 0;
        const projectedCv = estimatedCpa > 0 ? availableBudget / estimatedCpa : 0;
        const projectedSales = projectedCv * avgCustomerValue;
        const projectedProfit = projectedSales - (projectedCv * cogs) - availableBudget;
        const projectedRoi = availableBudget > 0 ? (projectedProfit / availableBudget) * 100 : 0;

        const resultsData = [
            { label: 'æ¨å®šCPA', value: formatCurrency(estimatedCpa), color: 'text-yellow-600', metric: 'estimated-cpa' },
            { label: 'äºˆæ¸¬CVæ•°', value: `${formatNumber(projectedCv)}ä»¶`, color: 'text-blue-600', metric: 'projected-cv' },
            { label: 'äºˆæ¸¬å£²ä¸Š', value: formatCurrency(projectedSales), color: 'text-teal-600', metric: 'projected-sales' },
            { label: 'äºˆæ¸¬åˆ©ç›Š', value: formatCurrency(projectedProfit), color: 'text-purple-600', metric: 'projected-profit' },
            { label: 'äºˆæ¸¬ROI', value: `${projectedRoi.toFixed(1)}%`, color: 'text-indigo-600', metric: 'projected-roi', fullWidth: true },
        ];
        renderResults(resultsData);
        
        renderScenarioSection(projectedCv, cvr, cpc, 'äºˆæ¸¬ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•°', formatNumber, 'ä»¶');
    }
    
    function calculateModeD() {
        const avgCustomerValue = parseFloat(document.getElementById('d-avgCustomerValue').value) || 0;
        const cogs = parseFloat(document.getElementById('d-cogs').value) || 0;
        const cvr = parseFloat(document.getElementById('common-cvr').value) || 0;
        const cpc = parseFloat(document.getElementById('common-cpc').value) || 0;
        const estimatedCpa = cvr > 0 ? cpc / (cvr / 100) : 0;
        let analysisHtml = '';
        
        if (modeD_kpi_choice === 'cv') {
            const targetCv = parseFloat(document.getElementById('d-targetCv').value) || 0;
            const requiredBudget = targetCv * estimatedCpa;
            const projectedSales = targetCv * avgCustomerValue;
            const projectedProfit = projectedSales - (targetCv * cogs) - requiredBudget;

            const resultsData = [
                { label: 'æ¨å®šCPA', value: formatCurrency(estimatedCpa), color: 'text-yellow-600', metric: 'estimated-cpa' },
                { label: 'å¿…è¦åºƒå‘Šäºˆç®—', value: formatCurrency(requiredBudget), color: 'text-teal-600', metric: 'required-budget' },
                { label: 'äºˆæ¸¬å£²ä¸Š', value: formatCurrency(projectedSales), color: 'text-indigo-600', metric: 'projected-sales' },
                { label: 'äºˆæ¸¬åˆ©ç›Š', value: formatCurrency(projectedProfit), color: 'text-purple-600', metric: 'projected-profit' },
            ];
            analysisHtml = `<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mt-4 rounded-r-lg text-sm col-span-2" role="alert">
                                  <p class="font-bold">è¨ˆç®—ã®å‰æ</p>
                                  <p>ã“ã®è¨ˆç®—ã¯ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹äºˆæ¸¬ï¼ˆæ¨å®šCPA: ${formatCurrency(estimatedCpa)}ï¼‰ã‚’åŸºã«ã€ç›®æ¨™CVæ•° ${formatNumber(targetCv)}ä»¶ã‚’é”æˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªåºƒå‘Šäºˆç®—ã‚’ç®—å‡ºã—ã¦ã„ã¾ã™ã€‚</p>
                                </div>`;
            renderResults(resultsData, analysisHtml);
            renderScenarioSection(targetCv, cvr, cpc, 'å¿…è¦åºƒå‘Šäºˆç®—', formatCurrency);

        } else { // cpa
            const targetCpa = parseFloat(document.getElementById('d-targetCpa').value) || 0;
            const targetProfit = parseFloat(document.getElementById('d-targetProfit').value) || 0;
            const profitPerCv = avgCustomerValue - cogs - targetCpa;
            const requiredCv = (profitPerCv > 0 && targetProfit > 0) ? Math.ceil(targetProfit / profitPerCv) : 0;
            const requiredBudget = requiredCv * targetCpa;
            const projectedSales = requiredCv * avgCustomerValue;

            const resultsData = [
                { label: '1CVã‚ãŸã‚Šã®åˆ©ç›Š', value: formatCurrency(profitPerCv), color: 'text-indigo-600' },
                { label: 'å¿…è¦CVæ•°', value: `${formatNumber(requiredCv)}ä»¶`, color: 'text-blue-600', metric: 'required-cv' },
                { label: 'å¿…è¦åºƒå‘Šäºˆç®—', value: formatCurrency(requiredBudget), color: 'text-teal-600', metric: 'required-budget' },
                { label: 'äºˆæ¸¬å£²ä¸Š', value: formatCurrency(projectedSales), color: 'text-purple-600', metric: 'projected-sales' },
            ];
             analysisHtml = `<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mt-4 rounded-r-lg text-sm col-span-2" role="alert">
                                  <p class="font-bold">è¨ˆç®—ã®å‰æ</p>
                                  <p>ã“ã®è¨ˆç®—ã¯ã€è¨­å®šã—ãŸç›®æ¨™CPAï¼ˆ${formatCurrency(targetCpa)}ï¼‰ã§ç›®æ¨™åˆ©ç›Šï¼ˆ${formatCurrency(targetProfit)}ï¼‰ã‚’é”æˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªCVæ•°ã¨åºƒå‘Šäºˆç®—ã‚’ç®—å‡ºã—ã¦ã„ã¾ã™ã€‚</p>
                                </div>`;
            renderResults(resultsData, analysisHtml);
            renderScenarioSection(requiredCv, cvr, cpc, 'å¿…è¦åºƒå‘Šäºˆç®—', formatCurrency);
        }
    }
    
    function renderScenarioSection(baseCv, cvr, cpc, title, formatter, unit = '', budget = null) {
        let valPessimistic, valRealistic, valOptimistic;
        
        if (currentMode === 'C') {
            const availableBudget = parseFloat(document.getElementById('c-availableBudget').value) || 0;
            const pessimisticCvr = cvr > 0 ? cvr * 0.5 : 0;
            const optimisticCvr = cvr * 1.5;
            const getProjectedCv = (targetCvr) => (targetCvr > 0 && cpc > 0 && availableBudget > 0) ? availableBudget / (cpc / (targetCvr / 100)) : 0;
            valPessimistic = getProjectedCv(pessimisticCvr);
            valRealistic = getProjectedCv(cvr);
            valOptimistic = getProjectedCv(optimisticCvr);
            resultsScenario.innerHTML = `
                <h4 class="text-md font-semibold text-center text-teal-800 mb-2">ã‚·ãƒŠãƒªã‚ªåˆ¥ ${title}</h4>
                <div class="space-y-3">
                    <div class="bg-red-100 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium text-red-800">æ‚²è¦³çš„ (CVR: ${pessimisticCvr.toFixed(1)}%)</span><span class="font-bold text-lg text-red-800">${formatter(valPessimistic)}${unit}</span></div></div>
                    <div class="bg-blue-100 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium text-blue-800">ç¾å®Ÿçš„ (CVR: ${cvr.toFixed(1)}%)</span><span class="font-bold text-lg text-blue-800">${formatter(valRealistic)}${unit}</span></div></div>
                    <div class="bg-green-100 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium text-green-800">æ¥½è¦³çš„ (CVR: ${optimisticCvr.toFixed(1)}%)</span><span class="font-bold text-lg text-green-800">${formatter(valOptimistic)}${unit}</span></div></div>
                </div>`;
        } else {
            const requiredCv = baseCv;
            const pessimisticCvr = cvr > 0 ? cvr * 0.5 : 0;
            const optimisticCvr = cvr * 1.5;
            const calculateBudgetForScenario = (targetCvr) => {
                if (targetCvr <= 0 || !isFinite(targetCvr) || cpc <= 0 || requiredCv <= 0) return 0;
                const clicksNeeded = requiredCv / (targetCvr / 100);
                return clicksNeeded * cpc;
            };
            valPessimistic = calculateBudgetForScenario(pessimisticCvr);
            valRealistic = calculateBudgetForScenario(cvr);
            valOptimistic = calculateBudgetForScenario(optimisticCvr);
             resultsScenario.innerHTML = `
                <h4 class="text-md font-semibold text-center text-teal-800 mb-2">ã‚·ãƒŠãƒªã‚ªåˆ¥ ${title}</h4>
                <div class="space-y-3">
                    <div class="bg-red-100 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium text-red-800">æ‚²è¦³çš„ (CVR: ${pessimisticCvr.toFixed(1)}%)</span><span class="font-bold text-lg text-red-800">${formatter(valPessimistic)}${unit}</span></div></div>
                    <div class="bg-blue-100 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium text-blue-800">ç¾å®Ÿçš„ (CVR: ${cvr.toFixed(1)}%)</span><span class="font-bold text-lg text-blue-800">${formatter(valRealistic)}${unit}</span></div></div>
                    <div class="bg-green-100 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium text-green-800">æ¥½è¦³çš„ (CVR: ${optimisticCvr.toFixed(1)}%)</span><span class="font-bold text-lg text-green-800">${formatter(valOptimistic)}${unit}</span></div></div>
                </div>`;
        }
        
        updateChart(title, ['æ‚²è¦³çš„', 'ç¾å®Ÿçš„', 'æ¥½è¦³çš„'], [valPessimistic, valRealistic, valOptimistic], formatter, unit);
    }

    function updateChart(label, labels, data, formatter, unit = '') {
        if (!budgetChart) return;

        const allDataIsZero = data.every(item => item === 0);

        if (allDataIsZero) {
            budgetChart.options.scales.y.max = 1; // Avoid chart collapsing completely
        } else {
            delete budgetChart.options.scales.y.max;
        }

        budgetChart.data.datasets[0].label = label;
        budgetChart.data.labels = labels;
        budgetChart.data.datasets[0].data = data;
        budgetChart.options.plugins.tooltip.callbacks.label = (context) => `${context.dataset.label}: ${formatter(context.raw)}${unit}`;
        budgetChart.options.scales.y.ticks.callback = (value) => formatter(value);
        budgetChart.update();
    }

    function initChart() {
        const ctx = document.getElementById('budgetChart').getContext('2d');
        budgetChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: [], datasets: [{ data: [], backgroundColor: ['rgba(239, 68, 68, 0.6)', 'rgba(59, 130, 246, 0.6)', 'rgba(34, 197, 94, 0.6)'], borderColor: ['rgba(239, 68, 68, 1)', 'rgba(59, 130, 246, 1)', 'rgba(34, 197, 94, 1)'], borderWidth: 1 }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: {} },
                    title: { display: true, text: 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®å¯è¦–åŒ–', font: { size: 16 }, color: '#374151', padding: { bottom: 20 } }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {}
                    }
                }
            }
        });
    }

    function setMode(mode) {
        currentMode = mode;
        simModeButtons.forEach(btn => {
            btn.classList.toggle('sim-mode-btn-active', btn.dataset.mode === mode);
            btn.classList.toggle('sim-mode-btn-inactive', btn.dataset.mode !== mode);
        });
        document.getElementById('mode-A-inputs').classList.toggle('hidden', mode !== 'A');
        document.getElementById('mode-B-inputs').classList.toggle('hidden', mode !== 'B');
        document.getElementById('mode-C-inputs').classList.toggle('hidden', mode !== 'C');
        document.getElementById('mode-D-inputs').classList.toggle('hidden', mode !== 'D');
        calculateAll();
    }

    simModeButtons.forEach(btn => btn.addEventListener('click', () => setMode(btn.dataset.mode)));
    simulatorInputs.forEach(input => input.addEventListener('input', calculateAll));

    document.getElementById('a-profit-btn').addEventListener('click', () => {
        modeA_cpa_calc_method = 'profit';
        document.getElementById('a-profit-wrapper').classList.remove('hidden');
        document.getElementById('a-roas-wrapper').classList.add('hidden');
        document.getElementById('a-roi-wrapper').classList.add('hidden');
        document.getElementById('a-profit-btn').classList.replace('optional-input-btn-inactive', 'optional-input-btn-active');
        document.getElementById('a-roas-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
        document.getElementById('a-roi-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
        calculateAll();
    });

    document.getElementById('a-roas-btn').addEventListener('click', () => {
        modeA_cpa_calc_method = 'roas';
        document.getElementById('a-profit-wrapper').classList.add('hidden');
        document.getElementById('a-roas-wrapper').classList.remove('hidden');
        document.getElementById('a-roi-wrapper').classList.add('hidden');
        document.getElementById('a-roas-btn').classList.replace('optional-input-btn-inactive', 'optional-input-btn-active');
        document.getElementById('a-profit-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
        document.getElementById('a-roi-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
        calculateAll();
    });

    document.getElementById('a-roi-btn').addEventListener('click', () => {
        modeA_cpa_calc_method = 'roi';
        document.getElementById('a-profit-wrapper').classList.add('hidden');
        document.getElementById('a-roas-wrapper').classList.add('hidden');
        document.getElementById('a-roi-wrapper').classList.remove('hidden');
        document.getElementById('a-roi-btn').classList.replace('optional-input-btn-inactive', 'optional-input-btn-active');
        document.getElementById('a-profit-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
        document.getElementById('a-roas-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
        calculateAll();
    });
    
    document.getElementById('d-cv-btn').addEventListener('click', () => {
        modeD_kpi_choice = 'cv';
        document.getElementById('d-cv-wrapper').classList.remove('hidden');
        document.getElementById('d-cpa-wrapper').classList.add('hidden');
        document.getElementById('d-cv-btn').classList.replace('optional-input-btn-inactive', 'optional-input-btn-active');
        document.getElementById('d-cpa-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
        calculateAll();
    });

    document.getElementById('d-cpa-btn').addEventListener('click', () => {
        modeD_kpi_choice = 'cpa';
        document.getElementById('d-cv-wrapper').classList.add('hidden');
        document.getElementById('d-cpa-wrapper').classList.remove('hidden');
        document.getElementById('d-cpa-btn').classList.replace('optional-input-btn-inactive', 'optional-input-btn-active');
        document.getElementById('d-cv-btn').classList.replace('optional-input-btn-active', 'optional-input-btn-inactive');
        calculateAll();
    });

    // Cost input toggling
    ['a', 'b', 'c'].forEach(prefix => {
        document.getElementById(`${prefix}-cost-type`).addEventListener('change', (e) => {
            document.getElementById(`${prefix}-cogs-wrapper`).classList.toggle('hidden', e.target.value !== 'cogs');
            document.getElementById(`${prefix}-margin-wrapper`).classList.toggle('hidden', e.target.value !== 'margin');
            calculateAll();
        });
    });

    function showSection(sectionId) {
        contentSections.forEach(section => section.classList.toggle('hidden', section.id !== sectionId));
        navButtons.forEach(button => {
            const isActive = button.dataset.section === sectionId;
            button.classList.toggle('nav-active', isActive);
            button.classList.toggle('nav-inactive', !isActive);
        });
    }

    navButtons.forEach(button => button.addEventListener('click', () => showSection(button.dataset.section)));
    
    function loadCaseStudy(caseId) {
        const cs = data.caseStudies.find(c => c.id === caseId);
        if (cs) {
            let realisticCogs = cs.cogs;
            if (!realisticCogs || realisticCogs <= 0) {
                const estimatedLimitCpa = (cs.profitPerCv || 0) * 2;
                realisticCogs = (cs.avgCustomerValue || 0) - estimatedLimitCpa;
                if (realisticCogs < 0) {
                    realisticCogs = 0;
                }
            }
            realisticCogs = Math.round(realisticCogs);

            // --- Start of Change: Calculate all CPA metrics ---
            const limitCpa = (cs.avgCustomerValue || 0) - realisticCogs;
            let targetCpa;

            if (cs.profitPerCv) {
                targetCpa = limitCpa - cs.profitPerCv;
            } else if (cs.targetRoas) {
                targetCpa = (cs.avgCustomerValue || 0) / (cs.targetRoas / 100);
            } else if (cs.targetRoi) {
                targetCpa = limitCpa / ((cs.targetRoi / 100) + 1);
            } else {
                targetCpa = limitCpa; // Fallback
            }

            const calculatedProfitPerCv = limitCpa - targetCpa;
            const calculatedRoas = targetCpa > 0 ? ((cs.avgCustomerValue || 0) / targetCpa) * 100 : 0;
            const calculatedRoi = targetCpa > 0 ? ((limitCpa - targetCpa) / targetCpa) * 100 : 0;
            
            document.getElementById('a-profitPerCv').value = Math.round(calculatedProfitPerCv);
            document.getElementById('a-targetRoas').value = calculatedRoas.toFixed(1);
            document.getElementById('a-targetRoi').value = calculatedRoi.toFixed(1);
            // --- End of Change ---


            // Mode A
            document.getElementById('a-targetProfit').value = cs.targetProfit || '';
            document.getElementById('a-avgCustomerValue').value = cs.avgCustomerValue || '';
            document.getElementById('a-cogs').value = realisticCogs;
            
            if (cs.targetRoas) {
                document.getElementById('a-roas-btn').click();
            } else if (cs.targetRoi) {
                document.getElementById('a-roi-btn').click();
            }
            else {
                document.getElementById('a-profit-btn').click();
            }

            // Common
            document.getElementById('common-cvr').value = cs.cvr || '';
            document.getElementById('common-cpc').value = cs.cpc || '';
            productDescriptionInput.value = cs.description || '';

            // Mode B
            const requiredCvForB = (cs.profitPerCv > 0 && cs.targetProfit > 0) ? Math.ceil(cs.targetProfit / cs.profitPerCv) : 0;
            const targetSales = requiredCvForB * cs.avgCustomerValue;
            document.getElementById('b-targetSales').value = Math.round(targetSales);
            document.getElementById('b-avgCustomerValue').value = cs.avgCustomerValue;
            document.getElementById('b-cogs').value = realisticCogs;
            
            // Mode C
            const estimatedCpaForC = cs.cvr > 0 ? cs.cpc / (cs.cvr / 100) : 0;
            const requiredBudgetForC = requiredCvForB * estimatedCpaForC;
            document.getElementById('c-availableBudget').value = Math.round(requiredBudgetForC);
            document.getElementById('c-avgCustomerValue').value = cs.avgCustomerValue;
            document.getElementById('c-cogs').value = realisticCogs;
            
            // Mode D
            document.getElementById('d-avgCustomerValue').value = cs.avgCustomerValue;
            document.getElementById('d-cogs').value = realisticCogs;
            document.getElementById('d-targetCv').value = requiredCvForB;
            const targetCpaFromProfit = (cs.avgCustomerValue - realisticCogs) - cs.profitPerCv;
            document.getElementById('d-targetCpa').value = Math.round(targetCpaFromProfit);
            document.getElementById('d-targetProfit').value = cs.targetProfit || '';

            calculateAll();
            showSection('simulator');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function populateCaseStudies() {
        const container = document.getElementById('caseStudiesContainer');
        container.innerHTML = data.caseStudies.map(cs => `<div class="case-study-card bg-white border border-gray-200 rounded-lg p-6 cursor-pointer" data-case-id="${cs.id}"><h3 class="text-lg font-bold text-teal-700">${cs.title}</h3><p class="text-gray-500">${cs.subtitle}</p><button class="mt-4 w-full bg-teal-600 text-white py-2 rounded-md hover:bg-teal-700 transition-colors">ã“ã®äº‹ä¾‹ã‚’èª­ã¿è¾¼ã‚€</button></div>`).join('');
        document.querySelectorAll('.case-study-card').forEach(card => card.addEventListener('click', () => loadCaseStudy(card.dataset.caseId)));
    }
    
    function populateBenchmarks() {
        const tabsContainer = document.getElementById('benchmarkTabs');
        const contentContainer = document.getElementById('benchmarkContent');
        tabsContainer.innerHTML = Object.keys(data.benchmarks).map((key, index) => `<button data-benchmark-key="${key}" class="benchmark-tab py-3 px-1 border-b-2 text-sm font-medium ${index === 0 ? 'tab-active' : 'tab-inactive'}">${data.benchmarks[key].name}</button>`).join('');
        function showBenchmarkContent(key) {
            const benchmark = data.benchmarks[key];
            contentContainer.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>${benchmark.headers.map(h => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr></thead><tbody class="bg-white divide-y divide-gray-200">${benchmark.rows.map(row => `<tr>${row.map(cell => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${cell}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
        }
        document.querySelectorAll('.benchmark-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                document.querySelectorAll('.benchmark-tab').forEach(t => t.classList.replace('tab-active', 'tab-inactive'));
                e.target.classList.replace('tab-inactive', 'tab-active');
                showBenchmarkContent(e.target.dataset.benchmarkKey);
            });
        });
        showBenchmarkContent(Object.keys(data.benchmarks)[0]);
    }

    function populateOptimizationGuide() {
        const container = document.getElementById('accordionContainer');
        container.innerHTML = data.optimization.map((item) => `<div class="border border-gray-200 rounded-lg"><button class="accordion-toggle w-full flex justify-between items-center p-4 text-left font-semibold text-gray-700 bg-gray-50 hover:bg-gray-100 focus:outline-none"><span>${item.title}</span><span class="transform transition-transform duration-300"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></span></button><div class="accordion-content"><div class="p-4 text-gray-600 bg-white">${item.content}</div></div></div>`).join('');
        document.querySelectorAll('.accordion-toggle').forEach(button => button.addEventListener('click', () => {
            const content = button.nextElementSibling;
            const icon = button.querySelector('svg').parentElement;
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                icon.style.transform = 'rotate(0deg)';
            } else {
                document.querySelectorAll('.accordion-content').forEach(c => c.style.maxHeight = null);
                document.querySelectorAll('.accordion-toggle span.transform').forEach(i => i.style.transform = 'rotate(0deg)');
                content.style.maxHeight = content.scrollHeight + "px";
                icon.style.transform = 'rotate(180deg)';
            }
        }));
    }

    function showLoading(title) { aiResultContainer.innerHTML = `<div class="bg-gray-50 p-6 rounded-lg text-center"><h3 class="text-lg font-semibold text-teal-800 mb-4">${title}</h3><div class="flex justify-center items-center"><div class="loader"></div><p class="ml-4 text-gray-600">AIãŒç”Ÿæˆä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p></div></div>`; }
    function showError(message) { aiResultContainer.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert"><strong class="font-bold">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:</strong><span class="block sm:inline"> ${message}</span></div>`; }
    
    async function callGeminiAPI(payload) {
        try {
             const response = await fetch('/.netlify/functions/callGemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API error (${response.status}): ${errorText}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                return result.candidates[0].content.parts[0].text;
            }
            throw new Error("äºˆæœŸã›ã¬APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã§ã™ã€‚");
        } catch (error) {
            console.error('Gemini API call failed:', error);
            showError(error.message);
            return null;
        }
    }

    function handleAIGeneration(type) {
        const productDescription = productDescriptionInput.value.trim();
        const adUrl = adUrlInput.value.trim();

        if (!productDescription && !adUrl) {
            showError("å®£ä¼ã—ãŸã„å•†å“ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã€ã¾ãŸã¯å‚è€ƒURLã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        if (type === 'copy') {
            generateAdCopy(productDescription, adUrl);
        } else if (type === 'targeting') {
            generateTargetingIdeas(productDescription, adUrl);
        }
    }
    
    generateCopyBtn.addEventListener('click', () => handleAIGeneration('copy'));
    generateTargetingBtn.addEventListener('click', () => handleAIGeneration('targeting'));

    async function generateAdCopy(productDescription, adUrl) {
        showLoading("åºƒå‘Šã‚³ãƒ”ãƒ¼ã‚’ç”Ÿæˆä¸­...");
        
        let prompt = `ã‚ãªãŸã¯å„ªç§€ãªãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ‹…å½“è€…ã§ã™ã€‚
ä»¥ä¸‹ã®æƒ…å ±ã«åŸºã¥ãã€Googleæ¤œç´¢åºƒå‘Šç”¨ã®åºƒå‘Šã‚³ãƒ”ãƒ¼ã‚’å³å¯†ã«6ãƒ‘ã‚¿ãƒ¼ãƒ³ææ¡ˆã—ã¦ãã ã•ã„ã€‚

# æŒ‡ç¤º
- å„åºƒå‘Šãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¯ã€å¿…ãšã€Œè¦‹å‡ºã—(headlines)ã€ã¨ã€Œèª¬æ˜æ–‡(descriptions)ã€ã®ä¸¡æ–¹ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
- è¦‹å‡ºã—ã¯30æ–‡å­—ä»¥å†…ã§3ã¤ä½œæˆã—ã¦ãã ã•ã„ã€‚
- èª¬æ˜æ–‡ã¯90æ–‡å­—ä»¥å†…ã§2ã¤ä½œæˆã—ã¦ãã ã•ã„ã€‚
- å‡ºåŠ›ã¯æŒ‡å®šã•ã‚ŒãŸJSONå½¢å¼ã«å³å¯†ã«å¾“ã£ã¦ãã ã•ã„ã€‚

# æä¾›æƒ…å ±`;
        
        if (productDescription) {
            prompt += `\n## å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æ¦‚è¦\n${productDescription}`;
        }
        if (adUrl) {
            prompt += `\n## å‚è€ƒURL\n${adUrl}`;
        }

        prompt += `\n\n# å‡ºåŠ›å½¢å¼
JSONå½¢å¼ã§ã€'ads'ã¨ã„ã†ã‚­ãƒ¼ã‚’æŒã¤é…åˆ—ã¨ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚é…åˆ—ã«ã¯å¿…ãš6ã¤ã®åºƒå‘Šãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
å„åºƒå‘Šãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€'headlines' (æ–‡å­—åˆ—ã®é…åˆ—) ã¨ 'descriptions' (æ–‡å­—åˆ—ã®é…åˆ—) ã®ã‚­ãƒ¼ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚`;

        const payload = { 
            contents: [{ role: "user", parts: [{ text: prompt }] }], 
            generationConfig: { 
                responseMimeType: "application/json", 
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        ads: {
                            type: "ARRAY",
                            description: "å¿…ãš6ã¤ã®åºƒå‘Šãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å«ã‚€é…åˆ—ã€‚",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    headlines: { type: "ARRAY", description: "30æ–‡å­—ä»¥å†…ã®è¦‹å‡ºã—3ã¤ã®é…åˆ—ã€‚", items: { type: "STRING" } },
                                    descriptions: { type: "ARRAY", description: "90æ–‡å­—ä»¥å†…ã®èª¬æ˜æ–‡2ã¤ã®é…åˆ—ã€‚", items: { type: "STRING" } }
                                },
                                required: ["headlines", "descriptions"]
                            }
                        }
                    },
                    required: ["ads"]
                }
            } 
        };

        const resultText = await callGeminiAPI(payload);
        if (resultText) {
            try { 
                const parsedResult = JSON.parse(resultText);
                if (parsedResult.ads && Array.isArray(parsedResult.ads) && parsedResult.ads.length > 0) {
                   displayAdCopy(parsedResult.ads);
                } else {
                   showError("AIãŒæœŸå¾…é€šã‚Šã®å½¢å¼ã§å¿œç­”ã—ã¾ã›ã‚“ã§ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
                   console.error("Invalid response structure:", parsedResult);
                }
            } catch (e) { 
                showError("AIã‹ã‚‰ã®å¿œç­”ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"); 
                console.error(e, resultText); 
            }
        }
    }
    
    async function generateTargetingIdeas(productDescription, adUrl) {
        showLoading("ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°æ¡ˆã®ç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ");
        
        let prompt = `ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ã‚¹ãƒˆã§ã™ã€‚
ä»¥ä¸‹ã®æƒ…å ±ã‚’åŸºã«ã€ãƒ‡ã‚¸ã‚¿ãƒ«åºƒå‘Šã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã«ãŠã‘ã‚‹å…·ä½“çš„ãªã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°æ¡ˆã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

# æä¾›æƒ…å ±`;

        if (productDescription) {
            prompt += `\n## å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æ¦‚è¦\n${productDescription}`;
        }
        if (adUrl) {
            prompt += `\n## å‚è€ƒURL\n${adUrl}`;
        }
        
        prompt += `\n\n# ææ¡ˆå†…å®¹
- æ¨å¥¨ã™ã‚‹åºƒå‘Šãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆGoogle, Meta, X, TikTokãªã©ï¼‰
- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¡§å®¢å±¤ã®ãƒšãƒ«ã‚½ãƒŠï¼ˆå¹´é½¢ã€æ€§åˆ¥ã€è·æ¥­ã€èˆˆå‘³ãƒ»é–¢å¿ƒãªã©ï¼‰
- å…·ä½“çš„ãªã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°è¨­å®šã®ä¾‹ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€èˆˆå‘³é–¢å¿ƒã‚«ãƒ†ã‚´ãƒªãªã©ï¼‰

ä¸Šè¨˜ã®é …ç›®ã«ã¤ã„ã¦ã€Markdownå½¢å¼ã§ã€è¦‹å‡ºã—ã‚„ãƒªã‚¹ãƒˆã‚’ä½¿ã£ã¦åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã—ã¦ãã ã•ã„ã€‚`;
        
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

        try {
            const response = await fetch('/.netlify/functions/callGemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ã‚¨ãƒ©ãƒ¼: ${response.statusText}`);
            }
            
            aiResultContainer.innerHTML = `<div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg" role="alert">
                <strong class="font-bold">AIãŒã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°æ¡ˆã‚’ç”Ÿæˆä¸­ã§ã™ã€‚</strong>
                <span class="block sm:inline">çµæœã¯æ•°åˆ†ä»¥å†…ã«ã€Netlifyã®ç®¡ç†ç”»é¢ã«ã‚ã‚‹ã€ŒFunctionsã€ãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚</span>
            </div>`;

        } catch (error) {
            showError(error.message);
        }
    }

    function displayAdCopy(ads) {
        if (!ads || ads.length === 0) { 
            showError("åºƒå‘Šã‚³ãƒ”ãƒ¼ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"); 
            return; 
        }
        let html = '<h3 class="text-lg font-semibold text-teal-800 mb-4 text-center">AIãŒç”Ÿæˆã—ãŸåºƒå‘Šã‚³ãƒ”ãƒ¼æ¡ˆ</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
        ads.forEach((ad, index) => {
            const headlinesHtml = (ad.headlines || []).map(h => `<li>${h}</li>`).join('');
            const descriptionsHtml = (ad.descriptions || []).map(d => `<li>${d}</li>`).join('');

            html += `<div class="bg-gray-50 border border-gray-200 rounded-lg p-4"><h4 class="font-bold mb-2 text-gray-700">ãƒ‘ã‚¿ãƒ¼ãƒ³ ${index + 1}</h4><div class="space-y-2"><div><p class="text-sm font-semibold text-teal-700">è¦‹å‡ºã—:</p><ul class="list-disc list-inside text-gray-600 text-sm">${headlinesHtml}</ul></div><div><p class="text-sm font-semibold text-teal-700">èª¬æ˜æ–‡:</p><ul class="list-disc list-inside text-gray-600 text-sm">${descriptionsHtml}</ul></div></div></div>`;
        });
        aiResultContainer.innerHTML = html + '</div>';
    }

    function displayTargetingIdeas(ideas) {
        aiResultContainer.innerHTML = `<h3 class="text-lg font-semibold text-teal-800 mb-4 text-center">AIãŒç”Ÿæˆã—ãŸã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°æ¡ˆ</h3><div class="bg-gray-50 border border-gray-200 rounded-lg p-6 prose max-w-none">${ideas.replace(/\n/g, '<br>')}</div>`;
    }

    // Tooltip logic
    document.body.addEventListener('click', (e) => {
        const icon = e.target.closest('.info-icon');
        if (icon) {
            const metricKey = icon.dataset.metric;
            const data = tooltipData[metricKey];
            
            if (tooltip.classList.contains('visible') && tooltip.dataset.currentMetric === metricKey) {
                tooltip.classList.remove('visible');
                return;
            }

            document.getElementById('tooltip-title').textContent = data.title;
            document.getElementById('tooltip-desc').innerHTML = data.desc; // Use innerHTML for <br>
            document.getElementById('tooltip-formula').innerHTML = data.formula;
            
            const iconRect = icon.getBoundingClientRect();
            
            tooltip.classList.add('visible'); // Make it visible before getting its size
            
            let top = iconRect.top + window.scrollY - tooltip.offsetHeight - 10;
            let left = iconRect.left + window.scrollX - (tooltip.offsetWidth / 2) + (iconRect.width / 2);

            if (top < window.scrollY) {
                top = iconRect.bottom + window.scrollY + 10;
            }
            if (left < 0) {
                left = 5;
            }
            if (left + tooltip.offsetWidth > window.innerWidth) {
                left = window.innerWidth - tooltip.offsetWidth - 5;
            }
            
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
            
            tooltip.dataset.currentMetric = metricKey;
        } else if (!e.target.closest('#tooltip')) {
             tooltip.classList.remove('visible');
        }
    });
    
    // --- Initial Load ---
    populateCaseStudies();
    populateBenchmarks();
    populateOptimizationGuide();
    initChart();
    setMode('A'); // Default to Mode A
    document.getElementById('a-profit-btn').classList.replace('optional-input-btn-inactive', 'optional-input-btn-active');
    document.getElementById('d-cv-btn').classList.replace('optional-input-btn-inactive', 'optional-input-btn-active');
});
</script>

</body>
</html>